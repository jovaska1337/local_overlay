
# HG changeset patch
# User Emilio Cobos √Ålvarez <emilio@crisal.io>
# Date 1755856729 0
# Node ID 73c71ee025c3f20a5f0b92bf7d01949380ef02a5
# Parent  bd786e50c087baf33ef13817fa3978e7fd732584
Bug 1975681 - Use opened / closed events for dbus menus. r=stransky

Co-authored-by: Vlad Zahorodnii <vlad.zahorodnii@kde.org>

Differential Revision: https://phabricator.services.mozilla.com/D261711


diff --git a/widget/gtk/NativeMenuGtk.cpp b/widget/gtk/NativeMenuGtk.cpp
--- a/widget/gtk/NativeMenuGtk.cpp
+++ b/widget/gtk/NativeMenuGtk.cpp
@@ -627,27 +627,36 @@ static MOZ_CAN_RUN_SCRIPT void DBusActiv
 
 static void ConnectActivated(DbusmenuMenuitem* aItem,
                              const dom::Element* aContent) {
   g_signal_connect(G_OBJECT(aItem), DBUSMENU_MENUITEM_SIGNAL_ITEM_ACTIVATED,
                    G_CALLBACK(DBusActivationCallback),
                    const_cast<dom::Element*>(aContent));
 }
 
-static MOZ_CAN_RUN_SCRIPT void DBusAboutToShowCallback(
-    DbusmenuMenuitem* aMenuitem, gpointer aUserData) {
+static MOZ_CAN_RUN_SCRIPT bool DBusEventCallback(DbusmenuMenuitem* aMenuItem,
+                                                 const gchar* name,
+                                                 GVariant* variant,
+                                                 guint timestamp,
+                                                 gpointer aUserData) {
   RefPtr element = static_cast<dom::Element*>(aUserData);
-  FireEvent(element, eXULPopupShowing);
-  FireEvent(element, eXULPopupShown);
+  if (strcmp(name, "opened") == 0) {
+    FireEvent(element, eXULPopupShowing);
+    FireEvent(element, eXULPopupShown);
+  } else if (strcmp(name, "closed") == 0) {
+    FireEvent(element, eXULPopupHiding);
+    FireEvent(element, eXULPopupHidden);
+  }
+  return false;
 }
 
-static void ConnectAboutToShow(DbusmenuMenuitem* aItem,
-                               const dom::Element* aContent) {
-  g_signal_connect(G_OBJECT(aItem), DBUSMENU_MENUITEM_SIGNAL_ABOUT_TO_SHOW,
-                   G_CALLBACK(DBusAboutToShowCallback),
+static void ConnectEvent(DbusmenuMenuitem* aItem,
+                         const dom::Element* aContent) {
+  g_signal_connect(G_OBJECT(aItem), DBUSMENU_MENUITEM_SIGNAL_EVENT,
+                   G_CALLBACK(DBusEventCallback),
                    const_cast<dom::Element*>(aContent));
 }
 
 void MenubarModelDBus::AppendMenuItem(DbusmenuMenuitem* aParent,
                                       const dom::Element* aChild) {
   nsAutoString label;
   aChild->GetAttr(nsGkAtoms::label, label);
   if (label.IsEmpty()) {
@@ -676,17 +685,17 @@ void MenubarModelDBus::AppendSubmenu(Dbu
                                      const dom::Element* aPopup) {
   RefPtr<DbusmenuMenuitem> submenu = dont_AddRef(dbusmenu_menuitem_new());
   if (RecomputeModelFor(submenu, *aPopup) == 0) {
     RefPtr<DbusmenuMenuitem> placeholder = dont_AddRef(dbusmenu_menuitem_new());
     dbusmenu_menuitem_child_append(submenu, placeholder);
   }
   nsAutoString label;
   aMenu->GetAttr(nsGkAtoms::label, label);
-  ConnectAboutToShow(submenu, aPopup);
+  ConnectEvent(submenu, aPopup);
   dbusmenu_menuitem_property_set(submenu, DBUSMENU_MENUITEM_PROP_LABEL,
                                  NS_ConvertUTF16toUTF8(label).get());
   dbusmenu_menuitem_child_append(aParent, submenu);
 }
 
 uint MenubarModelDBus::RecomputeModelFor(DbusmenuMenuitem* aParent,
                                          const dom::Element& aElement) {
   uint childCount = 0;
